# EPAGES-CS-2 - E-PAGES Coding Standart 2

<h1>Форматирование кода</h1>

Этот раздел стандарта описывает как принято оформлять код на PHP работая в 1С-Битрикс. 
Цель данного руководства — уменьшить когнитивное сопротивление при
визуальном восприятии кода, написанного разными авторами.

<h2>1. Обзор</h2>
<ul>
    <li>Структурирование текста</li>
    <li>Управляющие структуры, выражения</li>
    <li>Пустые строки и пробелы</li>
    <li>Прочее</li>
    <li>Правила форматирование кода в шаблонах</li>
</ul>

<h2>2. Структурирование текста</h2>
<h3>2.1. Длина строки</h3>
Нужно стараться избегать строк длиной более 120 символов. Если строка превышает этот размер, то нужно использовать правила переноса строки.

<h3>2.2. Правила переноса строки</h3>
Если длина строки превышает 120 символов, то необходимо пользоваться следующими правилами переноса:
<ul>
    <li>переносить можно после запятой или перед оператором;</li>
    <li>первый перенос ДОЛЖЕН быть сдвинут относительно верхней строки на 1 отступ;</li>
    <li>если в строке несколько переносов, то следующие переносы выравниваются на уровне первого;</li>
</ul>

<b>Пример 1:</b>

для строки
```php
<?php
$arAuthResult = $USER->ChangePassword($USER_LOGIN, $USER_CHECKWORD, $USER_PASSWORD, $USER_CONFIRM_PASSWORD, $USER_LID);
?>
```

допустимым будет следующий вариант переноса:
```php
<?php
$arAuthResult = $USER->ChangePassword(
	$USER_LOGIN,
	$USER_CHECKWORD,
    $USER_PASSWORD,
    $USER_CONFIRM_PASSWORD,
    $USER_LID
);
?>
```

<b>Пример 2:</b>

для строки
```php
<?php
if(COption::GetOptionString("main", "new_user_registration", "N")=="Y" && $_SERVER['REQUEST_METHOD']=='POST' && $TYPE=="REGISTRATION" && (!defined("ADMIN_SECTION") || ADMIN_SECTION!==true))
{
}
?>
```

допустимым будет следующий вариант переноса:
```php
<?php
if (COption::GetOptionString("main", "new_user_registration", "N") == "Y"
    && $_SERVER['REQUEST_METHOD'] == 'POST' && $TYPE == "REGISTRATION"
    && (!defined("ADMIN_SECTION") || ADMIN_SECTION !== true))
{
}
?>
```

<h3>2.3. Пробелы и табуляция</h3>
Для форматирования отступов в коде ДОЛЖНЫ использоваться пробелы. Один отступ равняется 4 пробелам.

<h3>2.4. Форматирование подчиненности</h3>
Подчиненный код ДОЛЖЕН быть сдвинут от главного ровно на один отступ. Размещать подчиненный код с тем же отступом, что и главный ЗАПРЕЩЕНО.
<br/>
<b>Пример:</b>
не правильно писать так:
```php
<?php
if ($a == 0) {$a = 10;
$b = 1;}
?>
```
правильно писать так:
```php
<?php
if ($a == 0)
{
	$a = 10;
	$b = 1;
}
?>
```

<h3>2.5. Классы, свойства и методы</h3>
Слово "класс" относится ко всем классам, интерфейсам и трейтам.

<h4>2.5.1 Ключевые слова и True/False/Null</h4>
[Ключевые слова PHP] НЕОБХОДИМО писать в нижнем регистре.

Константы PHP: `true`, `false`, и `null` НЕОБХОДИМО писать в нижнем регистре.

[Ключевые слова PHP]: http://php.net/manual/en/reserved.keywords.php

<h4>2.5.2. Пространства имён и оператор use</h4>
При наличии пространства имён (`namespace`), после его объявления необходимо оставить одну пустую строку.

При наличии операторов `use`, НЕОБХОДИМО располагать их после объявления пространства имён.

НЕОБХОДИМО использовать один оператор `use` на одно объявление (импорт или создание псевдонима).

НЕОБХОДИМО оставлять одну пустую строку после блока операторов `use`.

Например:

```php
<?php
namespace Vendor\Package;

use FooClass;
use BarClass as Bar;
use OtherVendor\OtherPackage\BazClass;

// ... additional PHP code ...
?>
```

<h4>2.5.3. Extends и implements</h4>

Ключевые слова `extends` и `implements` НЕОБХОДИМО располагать на одной
строке с именем класса.

Открывающую фигурную скобку класса НЕОБХОДИМО переносить на следующую строку;
закрывающую фигурную скобку класса НЕОБХОДИМО располагать на следующей строке
после тела класса.

```php
<?php
namespace Vendor\Package;

use FooClass;
use BarClass as Bar;
use OtherVendor\OtherPackage\BazClass;

class ClassName extends ParentClass implements \ArrayAccess, \Countable
{
    // константы, свойства, методы
}
?>
```

Список `implements` МОЖНО разбить на несколько строк, каждая из которых
с одним отступом. При этом, первый интерфейс в списке НЕОБХОДИМО перенести
на следующую строку, и в каждой строке НЕОБХОДИМО указать только один интерфейс.

```php
<?php
namespace Vendor\Package;

use FooClass;
use BarClass as Bar;
use OtherVendor\OtherPackage\BazClass;

class ClassName extends ParentClass implements
    \ArrayAccess,
    \Countable,
    \Serializable
{
    // константы, свойства, методы
}
?>
```

<h4>2.5.4. Свойства</h4>

Видимость НЕОБХОДИМО объявлять для всех свойств;

Использовать ключевое слово `var` для объявления свойств НЕДОПУСТИМО.

НЕДОПУСТИМО в одном объявлении указывать более одного свойства.

НЕ СЛЕДУЕТ начинать название свойства с подчёркивания для обозначения приватной
или защищённой видимости.

Объявление свойства выглядит как показано ниже.

```php
<?php
namespace Vendor\Package;

class ClassName
{
    public $foo = null;
}
?>
```

<h4>2.5.5. Методы</h4>

Видимость НЕОБХОДИМО объявлять для всех методов;

НЕ СЛЕДУЕТ начинать название метода с подчёркивания для обозначения приватной
или защищённой видимости.

НЕДОПУСТИМО объявлять методы с пробелом после названия метода. Открывающую
фигурную скобку НЕОБХОДИМО располагать на отдельной строке; закрывающую
фигурную скобку НЕОБХОДИМО располагать на следующей строке после тела метода.
НЕДОПУСТИМО оставлять пробел после открывающей круглой скобки и перед закрывающей.

Объявление метода выглядит как показано ниже. Обратите внимание на расположение
запятых, пробелов, круглых, квадратных и фигурных скобок:

```php
<?php
namespace Vendor\Package;

class ClassName
{
    public function fooBarBaz($arg1, &$arg2, $arg3 = [])
    {
        // тело метода
    }
}
?>
```

<h4>2.5.6. Аргументы методов</h4>

В списке аргументов НЕДОПУСТИМЫ пробелы перед запятыми, и НЕОБХОДИМ один пробел
после каждой запятой.

Аргументы метода со значениями по-умолчанию НЕОБХОДИМО располагать в конце
списка аргументов.

```php
<?php
namespace Vendor\Package;

class ClassName
{
    public function foo($arg1, &$arg2, $arg3 = [])
    {
        // тело метода
    }
}
?>
```

Список аргументов МОЖНО разбить на несколько строк, каждая из которых
с одним отступом. При этом, первый аргумент в списке НЕОБХОДИМО перенести
на следующую строку, и в каждой строке НЕОБХОДИМО указать только один аргумент.

Когда список аргументов разбит на несколько строк, закрывающую круглую скобку
НЕОБХОДИМО располагать на отдельной строке.

```php
<?php
namespace Vendor\Package;

class ClassName
{
    public function aVeryLongMethodName(
        ClassTypeHint $arg1,
        &$arg2,
        array $arg3 = []
    )
    {
        // тело метода
    }
}
?>
```

<h4>2.5.7. `abstract`, `final` и `static`</h4>

При наличии, ключевых слов `abstract` и `final`, НЕОБХОДИМО чтобы они
предшествовали модификаторам видимости.

При наличии, ключевого слова `static`, НЕОБХОДИМО чтобы оно слеовало за
модификатором видимости.

```php
<?php
namespace Vendor\Package;

abstract class ClassName
{
    protected static $foo;

    abstract protected function zim();

    final public static function bar()
    {
        // тело метода
    }
}
?>
```

<h4>2.5.8. Вызовы функций и методов</h4>

При вызове метода или функции НЕДОПУСТИМЫ пробелы между названием метода или
функции открывающей круглой скобкой, а так же НЕДОПУСТИМЫ пробелы после
открывающей круглой скобки и перед закрывающей. В списке аргументов НЕДОПУСТИМЫ
пробелы перед запятыми, и НЕОБХОДИМ один пробел после каждой запятой.

```php
<?php
bar();
$foo->bar($arg1);
Foo::bar($arg2, $arg3);
?>
```

Список аргументов МОЖНО разбить на несколько строк, каждая из которых
с одним отступом относительно главного кода. При этом, первый аргумент в списке НЕОБХОДИМО перенести
на следующую строку, и в каждой строке НЕОБХОДИМО указать только один аргумент.

```php
<?php
$foo->bar(
    $longArgument,
    $longerArgument,
    $muchLongerArgument
);
?>
```


<h2>3. Управляющие структуры, выражения</h2>
<h3>3.1. Выражения</h3>
Желательно, чтобы в каждой строчке присутствовало только одно выражение.

<b>Пример:</b>

не правильно писать так:
```php
<?php
$a = $b; $b = $c; $c = $a;
?>
```
правильно писать так:
```php
<?php
$a = $b;
$b = $c;
$c = $a;
?>
```

<h3>3.2. Управляющие структуры if, else, while и т.п.</h3>

Допустим один вид написания инструкций:

тело управляющей структуры ДОЛЖНО заключаться в фигурные скобки

```php
<?php
if (условие) 
{
	действие1;
}
else 
{
	действие2;
} 
?>
```

При написании инструкций ДОЛЖНО применяться правило "2.4. Форматирование подчиненности", тело управляющей структуры ДОЛЖНО быть сдвинуто на один отступ от самой управляющей структуры. Фигурные скобки ДОЛЖНЫ находиться на отдельных строках и ДОЛЖНЫ быть на одном уровне с инструкцией.

<b>Пример:</b>

не правильно писать так:
```php
<?php
if ($a == 0) $a = 10;
else{
$a = 5;
$b = 10;}
?>
```
правильно писать так:
```php
<?php
if ($a == 0)
{
	$a = 10;
}
else
{
	$a = 5;
	$b = 10;
}
?>
```

Вместо `else if` СЛЕДУЕТ использовать `elseif` чтобы все ключевые слова
управляющих структур выглядели как одно слово.

<h3>3.3. Сложные управляющие структуры</h3>
Сложные управляющие структуры СЛЕДУЕТ разбивать по строкам в соответствии с правилами пункта 3.2. (Управляющие структуры if, else, while и т.п.) и 2.2. (Правила переноса строки)

Например,
```php
<?php
if(COption::GetOptionString("main", "new_user_registration", "N")=="Y" && $_SERVER['REQUEST_METHOD']=='POST' &&
$TYPE=="REGISTRATION" && (!defined("ADMIN_SECTION") || ADMIN_SECTION!==true))
{
}
?>
```
можно записать как
```php
<?php
if (
	COption::GetOptionString("main", "new_user_registration", "N") == "Y"
	&& $_SERVER['REQUEST_METHOD'] == 'POST' && $TYPE == "REGISTRATION"
	&& (!defined("ADMIN_SECTION") || ADMIN_SECTION !== true)
)
{
	//тело
}
elseif (
	длинноеУсловие1
	||длинноеУсловие2
	||длинноеУсловие3
)
{
	//тело
}
?>
```

Очень сложные управляющие структуры рекомендуется разбивать на несколько более простых.

Например,
```php
<?php
if((!(defined("STATISTIC_ONLY") && STATISTIC_ONLY && substr($APPLICATION->GetCurPage(), 0,
strlen(BX_ROOT."/admin/"))!=BX_ROOT."/admin/")) && COption::GetOptionString("main", "include_charset", "Y")=="Y"
&& strlen(LANG_CHARSET)>0)
?>
```
можно записать так:
```php
<?php
$publicStatisticOnly = false;
if (
	defined("STATISTIC_ONLY")
	&& STATISTIC_ONLY 
	&& substr($APPLICATION->GetCurPage(), 0, strlen(BX_ROOT."/admin/")) != BX_ROOT."/admin/"
)
{
	$publicStatisticOnly = true;
} 

if (
	!$publicStatisticOnly
	&& strlen(LANG_CHARSET) > 0
	&& COption::GetOptionString("main", "include_charset", "Y") == "Y"
)
{
}
?>
```
или так:
```php
<?php
if (
	!defined("STATISTIC_ONLY")
	|| !STATISTIC_ONLY
	|| substr($APPLICATION->GetCurPage(), 0, strlen(BX_ROOT."/admin/")) == BX_ROOT."/admin/"
)
{ 
	if (strlen(LANG_CHARSET) > 0 && COption::GetOptionString("main", "include_charset", "Y") == "Y")
	{

	} 
}
?>
```

<h3>3.4. Форматирование массивов</h3>
Массивы, которые записываются в несколько строк, СЛЕДУЕТ форматировать следующим образом:
```php
<?php
$arFilter = array(
	"key1" => "value1",
	"key2" => array(
		"key21" => "value21",
		"key22" => "value22",
	)
);
?>
```

<h2>4. Пустые строки и пробелы</h2>
<h3>4.1. Пустые строки</h3>
Пустые строки помогают разбивать код приложения на логические сегменты. Несколькими строками МОГУТ отделяться секции в исходном файле. Одной пустой строкой отделяются друг от друга методы, логические секции внутри метода для более удобного чтения. Перед логической секцией РЕКОМЕНДУЕТСЯ вставить комментарий, в котором будет указано назначение этой секции (см. <a href="https://github.com/rodion-arr/EpagesCodingStandards/blob/master/PHP/EPAGES-CS-4.md">EPAGES-CS-4</a>).


<h3>4.1. Пробелы</h3>
После запятой, если она не последняя в строке, ДОЛЖЕН быть пробел. После точки с запятой, если она не последняя в строке (например в управляющей структуре for), ДОЛЖЕН быть пробел. Перед запятой или точкой с запятой пробелы не ставятся. Все операторы ДОЛЖНЫ быть отделены пробелом от операндов с обеих сторон. Замена пробела символом табуляции НЕ ДОПУСКАЕТСЯ.

<b>Пояснения:</b>

Один пробел используется в объявлении методов после запятой, но не перед скобками:
```php
<?php
testMethod($a, $b, $c);
?>
```

Пример неправильного использования:
```php
<?php
testMethod($a,$b,$c);
?>
```

либо
```php
<?php
testMethod( $a, $b, $c );
?>
```

Так же одиночный пробел может быть использован для выделения операторов:
```php
<?php
$a = $b * $c / $d;
?>
```

Пример неправильного использования:
```php
<?php
$a=$b*$c/$d;
?>
```

Также пробелы используются при форматировании циклов:
```php
<?php
for ($i = 0; $i < 10; $i++)
{
}
?>
```

Пример неправильного использования:
```php
<?php
for($i=0;$i<10;$i++)
{
}
?>
```

Табличное форматирование с помощью символов табуляции НЕ ДОЛЖНО использоваться.

Пример неправильного форматирования:
```php
<?php
$arArray = array(
	"key1RealyLong" => "value1",
	"key2"			=> "value2",
);
?>
```

<b>Замечание:</b> присутствие или отсутствие пробела после if правилами не регламентируется.

<h2>5. Прочее</h2>
В сложных выражениях рекомендуется группировать операции с помощью скобок вне зависимости от того, требует это приоритет операций или нет.

Пример:
```php
<?php
$r = $a + ($b * $c);
?>
```
<h2>6. Правила форматирование кода в шаблонах</h2>
<ul>
	<li>Операторы типа <code>if()</code>, <code>foreach()</code>, <code>while()</code> и т.д. в шаблоне компонента вместе с html-версткой НЕ ДОЛЖНЫ использоваться фигурные скобки. СЛЕДУЕТ заменить фигурные скобки Альтернативным синтаксисом управляющих структур</li>
</ul>

Пример плохого кода, где из-за фигурных скобок пострадала читабельность:
```php
<?if ($condition === true) 
{?>
	<a href="/programm.php">Link text</a>
<?}elseif ($condition === true) 
{?>
	<a href="/programm.php">Link text</a>
<?}else 
{?>
	<a href="/programm.php">Link text</a>
<?}?>
```

Примеры правильного кода:
```php
<?if ($condition === true):?>
	<a href="<?=$link?>">Link text</a>
<?elseif ($condition === true):?>
	<a href="/programm.php">Link text</a>
<?else:?>
	<a href="/programm.php">Link text</a>
<?endif?>
```

<ul>
	<li>НЕ РЕКОМЕНДУЕТСЯ выводить элементы верстки используя конструкцию языка <code>echo</code> или функцию <code>print</code>. СЛЕДУЕТ прервать PHP-код тэгом <code>?></code> и разместить после него нужные html-элементы</li>
</ul>
